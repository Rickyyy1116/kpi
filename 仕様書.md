# 1. 目的・背景

2人で運営する会社向けに、「ゴール → KPI → 行動（タスク）」を一気通貫で可視化・更新できる軽量Webアプリを作る。タスク管理アプリというより **KPIドリブンで進捗と責任を明確化** することが主目的。

* 想定ユーザー：固定の2名（将来N名拡張可能な設計）
* 重視する体験：毎日/毎週のチェックインでKPI値を記録→ゴール進捗%とネクストアクションが即座に共有される

---

# 2. 用語

* **Goal（ゴール）**：期限付きの最上位目標（例：12/31に月商100万円）
* **KPI**：ゴール達成のために追う定量指標（例：週あたり商談数、CPA、動画投稿本数）
* **Check-in（KPI更新）**：KPIの定期入力（値・日付・メモ）
* **Action（行動/タスク）**：KPIを動かす具体施策（任意。KPIに紐付け）
* **Owner**：Goal/KPI/Actionの責任者（A or B）

---

# 3. MVPスコープ

1. サインアップ/サインイン（2名）
2. Goal作成/編集/アーカイブ（期限・数値目標・担当）
3. KPI作成（方向性↑/↓、目標値、頻度、担当）
4. KPI Check-in（値・日付・メモ）
5. 進捗計算とダッシュボード（個人/全体）
6. コメント・相互フィードバック（Goal・KPIに紐付け）
7. 期日や未更新の軽量通知（アプリ内 + メール）

---

# 4. 画面一覧（MVP）

* **/signin**：ログイン
* **/**（Dashboard）：各人の本日のToDo、今週のKPI、今月のGoal進捗%をカードで表示
* **/goals**：一覧 + 作成/編集モーダル
* **/goals/[id]**：詳細（KPIリスト、進捗チャート、コメント、関連Actions）
* **/kpis**：KPI一覧（責任者・頻度・最終更新）
* **/kpis/[id]**：詳細（履歴チャート、Check-inフォーム、コメント）
* **/actions**：行動（タスク）一覧（任意、期限・担当・状態）
* **/settings**：プロフィール、通知設定

---

# 5. 主要ユースケース

* UC-1：Goal作成 → KPI紐付け → 期日まで週次でCheck-in
* UC-2：毎日のCheck-inでKPI値を入力 → 進捗%と達成確率を可視化
* UC-3：未更新/期限切れをバッジ表示 → 相手が何に詰まっているかコメントで可視化

---

# 6. 非機能要件

* **性能**：ダッシュボード初回表示 < 1.5s（キャッシュ/KV活用）
* **可用性**：Cloudflare Pages/Functions + D1（SLAに準拠）
* **拡張性**：ユーザーをN名へ容易に拡張可能（Teamテーブル設計）
* **セキュリティ**：Auth（Clerk/Auth.js）+ RLS相当のテーブルスコープチェック
* **監査**：全ての更新にcreated_by/updated_byとタイムスタンプ

---

# 7. データモデル（ERテキスト）

```
User (id, email, name, avatar_url, created_at)
Team (id, name, created_at)
TeamMember (id, team_id, user_id, role['owner','member'])
Goal (id, team_id, title, description, owner_id, target_value, unit, due_date, status['active','archived'], created_at)
KPI (id, goal_id, title, description, owner_id, target_value, unit, direction['up','down'], frequency['daily','weekly','monthly'], status['active','archived'], created_at)
KPIUpdate (id, kpi_id, value, note, recorded_at, created_by)
Action (id, kpi_id, title, description, owner_id, due_date, state['todo','doing','done'], created_at)
Comment (id, entity_type['goal','kpi','action'], entity_id, body, created_by, created_at)
Notification (id, user_id, type, payload_json, read_at, created_at)
```

将来拡張：File（添付）、Follower（ウォッチ）、Integration（Slack/LINE通知）

---

# 8. 進捗計算ロジック

* Goal進捗% = Σ(KPI貢献度 × KPI達成率)

  * KPI達成率 = （方向がupの場合）`current / target` を上限1.2でクリップ
  * KPI達成率 = （方向がdownの場合）`target / current` を上限1.2でクリップ
  * KPI貢献度はGoal内で手動配分（合計=1.0）。未設定時は等配。
* **達成確率（簡易）**：

  * 直近n回の移動平均トレンド傾きβと残日数dから、`prob = sigmoid(a*β - b/d)`（パラメータa,bは経験則）。MVPは棒グラフ+トレンドで十分。

---

# 9. API設計（App Router, Edge Runtime想定）

* `POST /api/goals`：Goal作成
* `GET /api/goals`：Goal一覧（teamスコープ）
* `GET /api/goals/:id` / `PATCH /api/goals/:id`
* `POST /api/kpis` / `GET /api/kpis` / `GET|PATCH /api/kpis/:id`
* `POST /api/kpis/:id/updates` / `GET /api/kpis/:id/updates`
* `POST /api/actions` / `PATCH /api/actions/:id`
* `POST /api/comments`（共通：entity_type, entity_id）
* `GET /api/dashboard`（集計）

**認可**：全APIで`team_id`スコープ検証（TeamMemberに存在かつrole許可）。

---

# 10. スキーマ（Cloudflare D1 × Drizzle）

`/src/db/schema.ts`

```ts
import { sqliteTable, text, integer, real } from 'drizzle-orm/sqlite-core';
import { sql } from 'drizzle-orm';

export const users = sqliteTable('users', {
  id: text('id').primaryKey(),
  email: text('email').notNull().unique(),
  name: text('name').notNull(),
  avatarUrl: text('avatar_url'),
  createdAt: integer('created_at', { mode: 'timestamp_ms' }).default(sql`CURRENT_TIMESTAMP`)
});

export const teams = sqliteTable('teams', {
  id: text('id').primaryKey(),
  name: text('name').notNull(),
  createdAt: integer('created_at', { mode: 'timestamp_ms' }).default(sql`CURRENT_TIMESTAMP`)
});

export const teamMembers = sqliteTable('team_members', {
  id: text('id').primaryKey(),
  teamId: text('team_id').notNull().references(() => teams.id),
  userId: text('user_id').notNull().references(() => users.id),
  role: text('role', { enum: ['owner','member'] }).notNull()
});

export const goals = sqliteTable('goals', {
  id: text('id').primaryKey(),
  teamId: text('team_id').notNull().references(() => teams.id),
  title: text('title').notNull(),
  description: text('description'),
  ownerId: text('owner_id').notNull().references(() => users.id),
  targetValue: real('target_value').notNull(),
  unit: text('unit').notNull(),
  dueDate: integer('due_date'),
  status: text('status', { enum: ['active','archived'] }).default('active'),
  createdAt: integer('created_at', { mode: 'timestamp_ms' }).default(sql`CURRENT_TIMESTAMP`)
});

export const kpis = sqliteTable('kpis', {
  id: text('id').primaryKey(),
  goalId: text('goal_id').notNull().references(() => goals.id),
  title: text('title').notNull(),
  description: text('description'),
  ownerId: text('owner_id').notNull().references(() => users.id),
  targetValue: real('target_value').notNull(),
  unit: text('unit').notNull(),
  direction: text('direction', { enum: ['up','down'] }).notNull(),
  frequency: text('frequency', { enum: ['daily','weekly','monthly'] }).notNull(),
  weight: real('weight').default(1),
  status: text('status', { enum: ['active','archived'] }).default('active'),
  createdAt: integer('created_at', { mode: 'timestamp_ms' }).default(sql`CURRENT_TIMESTAMP`)
});

export const kpiUpdates = sqliteTable('kpi_updates', {
  id: text('id').primaryKey(),
  kpiId: text('kpi_id').notNull().references(() => kpis.id),
  value: real('value').notNull(),
  note: text('note'),
  recordedAt: integer('recorded_at', { mode: 'timestamp_ms' }).notNull(),
  createdBy: text('created_by').notNull().references(() => users.id)
});

export const actions = sqliteTable('actions', {
  id: text('id').primaryKey(),
  kpiId: text('kpi_id').references(() => kpis.id),
  title: text('title').notNull(),
  description: text('description'),
  ownerId: text('owner_id').notNull().references(() => users.id),
  dueDate: integer('due_date'),
  state: text('state', { enum: ['todo','doing','done'] }).default('todo'),
  createdAt: integer('created_at', { mode: 'timestamp_ms' }).default(sql`CURRENT_TIMESTAMP`)
});

export const comments = sqliteTable('comments', {
  id: text('id').primaryKey(),
  entityType: text('entity_type', { enum: ['goal','kpi','action'] }).notNull(),
  entityId: text('entity_id').notNull(),
  body: text('body').notNull(),
  createdBy: text('created_by').notNull().references(() => users.id),
  createdAt: integer('created_at', { mode: 'timestamp_ms' }).default(sql`CURRENT_TIMESTAMP`)
});
```

---

# 11. APIハンドラ例（Next.js App Router）

`/app/api/kpis/[id]/updates/route.ts`

```ts
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { kpiUpdates } from '@/db/schema';
import { nanoid } from 'nanoid';
import { authUser, assertTeamScope } from '@/lib/authz';

export async function POST(req: NextRequest, { params }: { params: { id: string } }) {
  const user = await authUser(req);
  const body = await req.json();
  const { value, note, recordedAt } = body;

  await assertTeamScope(user, { kpiId: params.id });

  await db.insert(kpiUpdates).values({
    id: nanoid(),
    kpiId: params.id,
    value,
    note,
    recordedAt: recordedAt ?? Date.now(),
    createdBy: user.id,
  });
  return NextResponse.json({ ok: true });
}
```

---

# 12. 権限/認可

* すべての読み書きは `team_id` でスコープ
* 2名前提：`role = owner` 2名でもOK。将来はowner/memberで操作権限を分離
* コメン ト削除は作成者 or owner のみ

---

# 13. 通知設計

* **未更新通知**：頻度を超えて未更新のKPIをバッジ表示（Dashboard）
* **メール通知**：毎朝9時（Asia/Tokyo）に未更新KPIのサマリ（Cloudflare Queues + Cron Triggers）

---

# 14. 技術スタック

* **フロント**：Next.js 15（App Router, Server Actions/Edge）+ TypeScript + Tailwind + shadcn/ui + Recharts
* **認証**：Clerk or Auth.js（Email/Passkey）
* **DB**：Cloudflare D1（Drizzle ORM）+ KV（ダッシュボードキャッシュ）
* **Functions**：Cloudflare Pages Functions（/api）
* **ジョブ**：Cloudflare Queues + Cron Triggers（毎朝リマインド）
* **監視**：Cloudflare Analytics/Logs

---

# 15. デプロイ/環境

* Cloudflare PagesにGit連携 → 自動ビルド
* `wrangler.toml` 例：

```toml
name = "kpi-duo"
compatibility_date = "2024-11-21"

[[d1_databases]]
binding = "DB"
database_name = "kpi-duo-db"
database_id = "<your-d1-id>"

[[kv_namespaces]]
binding = "CACHE"
id = "<your-kv-id>"

[triggers]
crons = ["0 0 * * *"] # UTC 0:00 = JST 9:00
```

* 環境変数：`CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY` or Auth.js secrets

---

# 16. ディレクトリ構成（例）

```
src/
  app/
    (auth)/signin/page.tsx
    page.tsx               # Dashboard
    goals/page.tsx
    goals/[id]/page.tsx
    kpis/page.tsx
    kpis/[id]/page.tsx
    actions/page.tsx
    api/ ...               # Route Handlers (Edge)
  components/
    kpi-card.tsx
    goal-progress.tsx
    charts/kpi-line.tsx
  db/
    index.ts               # drizzle init (D1 binding)
    schema.ts
  lib/
    authz.ts
    calc.ts                # 進捗・達成率ロジック
    cache.ts
```

---

# 17. UI要件（主要コンポーネント）

* **GoalProgress**：Goal内KPIの進捗%リング + 期限まで残日数
* **KpiCard**：最新値/目標/方向/頻度/最終更新日を表示、1クリックCheck-in
* **TrendChart**：直近n回の折れ線 + 移動平均
* **OverdueBadge**：未更新/期限超過バッジ

---

# 18. バリデーション/ビジネスルール

* KPI targetValue > 0、direction必須
* Check-inは1日1件まで（frequency=dailyの場合）※将来設定で変更
* Goalは少なくとも1 KPI必須（進捗%算出のため）

---

# 19. テスト計画

* **ユニット**：calc.ts（達成率/重み付け/方向）
* **API**：認可（teamスコープ）・バリデーション
* **E2E**：Sign-in→Goal作成→KPI作成→Check-in→Dashboard反映（Playwright）

---

# 20. リリース計画

* **M0（1週）**：スキーマ/認証/Goal/KPI CRUD
* **M1（+1週）**：Check-in/ダッシュボード/簡易チャート
* **M2（+1週）**：通知（未更新/毎朝メール）・コメント

---

# 21. 将来拡張

* Slack/LINE通知、モバイルPWA、権限の詳細化（reviewer）、インサイト（予測・異常検知）、インポート/エクスポート、テンプレ（OKR/NSM）

---

# 22. 開発メモ（Cursorでの初期ブート）

* `pnpm dlx create-next-app@latest`（App Router, TS, Tailwind）
* `pnpm add drizzle-orm drizzle-kit better-sqlite3`（ローカル）
* `pnpm add -D wrangler`（CF）
* `pnpm add @cloudflare/next-on-pages`→ Pages用アダプタ
* DrizzleでD1スキーマ生成 → `wrangler d1 migrations apply`

---

# 23. サンプル：進捗計算（calc.ts）

```ts
export function kpiRatio({ dir, current, target }: { dir: 'up'|'down'; current: number; target: number; }) {
  if (target <= 0) return 0;
  const r = dir === 'up' ? current/target : target/Math.max(current, 0.0001);
  return Math.min(r, 1.2);
}

export function goalProgress(kpis: { weight?: number; ratio: number; }[]) {
  const totalW = kpis.reduce((s,k)=> s + (k.weight ?? 1), 0) || 1;
  const score = kpis.reduce((s,k)=> s + (k.ratio * (k.weight ?? 1)), 0) / totalW;
  return Math.round(score * 100);
}
```

---

# 24. セキュリティ

* すべての`/api`でセッション検証、TeamMember確認
* 監査ログ（KPIUpdate/Commentは作成者必須）
* レート制限（IP + user）をCF Rulesで

---

# 25. 受け入れ基準（MVP）

* 2人がGoal/KPIを作成し、毎日Check-inを入れるとDashboardに進捗%が正しく表示される
* 未更新KPIがDashboardとメールに反映される（JST 9時）
* すべての読み書きがチーム外からは不可

---

# ★ シンプルMVP（画面3つ縛り）版

> まずは**極小機能**で運用を開始 → 実データから不足を見極めて順次拡張。

## 1) 機能一覧（詳細）

### 必須（MUST）

* 認証：2名のみ（固定Team）。
* Goal：作成/編集/アーカイブ（タイトル・期限・目標値・単位・Owner）。
* KPI：Goal配下に作成/編集/削除（タイトル・方向↑/↓・目標値・単位・頻度daily/weekly/monthly・Owner）。
* Check-in：KPIへの数値入力＋任意メモ。Dashboardから**クイック入力**可。
* 進捗％：KPI達成率の等配平均でGoal進捗％を算出し、Dashboardのリングに表示。
* 未更新バッジ：頻度基準を超えたKPIに赤バッジ（Dashboard上部に件数）。
* 履歴：KPIごとの時系列一覧、直近1件のみ編集/削除可、CSVエクスポート。

### 後回し（NEXT）

* コメント、タスク（Action）、通知（メール/Slack/LINE）、重み付け編集、テンプレ、OKR/NSMプリセット、予測/異常検知。

---

## 2) 画面構成（最大3画面）

### 画面A：Dashboard（ホーム / `/`）

* **目的**：本日の更新と全体把握を**この1画面で完結**。
* **要素**：

  * ヘッダー：本日の日付、ユーザー切替（A/B）、未更新KPI件数バッジ。
  * Goalカード（最大3）：進捗リング、残日数、配下KPIミニリスト（最新値/目標/方向/最終更新）。
  * クイックCheck-in：各KPI行に数値入力＋メモ（Enterで保存、楽観更新）。
  * 空状態（Empty State）：初回は「Goal作成」導線だけ表示。
* **操作**：`+ Goal`（モーダル or 画面Bへ）／KPI名クリックで画面Cへ。

### 画面B：Setup（Goal & KPI設定 / `/setup`）

* **目的**：構成の初期設定と日常の軽微な編集。
* **要素**：

  * Goalフォーム：タイトル/期限/目標値/単位/Owner。
  * KPIテーブル：タイトル/方向/目標値/単位/頻度/Owner。行追加/編集/削除。
  * 重み付け：**等配固定**（編集は後回し）。
* **制約**：Active Goalは最大3推奨（UI簡素化）。

### 画面C：History（KPI履歴 / `/kpi/[id]`）

* **目的**：1つのKPIの軌跡を正しく残す。
* **要素**：KPI概要（目標/方向/頻度/Owner/所属Goal）／スパークライン（直近n回）／履歴テーブル（日時・値・メモ・操作）／CSV出力。
* **操作**：新規Check-in、直近1件の編集/削除。

---

## 3) ユースケース（E2E）

1. 初回：画面Aの空状態 → `+Goal` → 画面BでGoal/KPI作成 → 画面Aへ戻る。
2. 日次/週次運用：画面Aで各KPIに数値入力 → 進捗リングと未更新バッジが即反映。
3. 誤入力修正：画面Cに移動 → 直近1件だけ修正、CSV出力で週報/会議に利用。

---

## 4) バリデーション/ビジネスルール（最小）

* KPI targetValue > 0、direction ∈ {up,down}、frequency ∈ {daily,weekly,monthly}。
* Check-inは frequency 基準で1期間1件（同日二重入力は上書き確認）。
* Goalは少なくとも1 KPIが必要（進捗計算のため）。

---

## 5) API（最小）

* `POST /api/goals` / `GET /api/goals` / `PATCH /api/goals/:id`
* `POST /api/kpis` / `GET /api/kpis?goalId=` / `PATCH /api/kpis/:id` / `DELETE /api/kpis/:id`
* `POST /api/updates`（kpiId, value, note, recordedAt） / `GET /api/updates?kpiId=` / `PATCH /api/updates/:id`（直近のみ）
* `GET /api/dashboard`（各Goalの進捗％、未更新KPI一覧）

**認可**：Team所属検証（TeamMember）、対象Goal/KPIが同一teamであること。

---

## 6) スキーマ（最小 / Drizzle for D1）

* 既存のスキーマから **Action/Comment/Notification を除外**。User/Team/TeamMember/Goal/KPI/KPIUpdateのみ。

---

## 7) 計算・判定（最小）

* KPI達成率 =（up）`current/target`（max1.2）／（down）`target/max(current,0.0001)`（max1.2）。
* Goal進捗％ = 配下KPI達成率の**等配平均**。
* 未更新：frequencyに応じて日数閾値（1/7/30日）を超えたらtrue。

---

## 8) 受け入れ基準（MVP）

* 3画面のみで主要ユースケースが完遂できる。
* 2名がCheck-inするとDashboard進捗リングが即反映。
* 未更新KPIがDashboardと`GET /api/dashboard`に一致。
* 直近Check-inだけが編集可能である。

---

## 9) 実装メモ（Cursor向け）

* 先に画面A（静的UI）→ ダミーデータで動作 → API仮実装 → D1接続の順。
* チャートはRechartsのLineChartのみ。スパークライン用の最小構成。
* Edge Runtime + D1：読み取りはキャッシュ（KV）→ 書き込みで無効化。

